#!/bin/bash
COLOR_GREEN="\033[0;32m"
COLOR_BLUE="\033[0;34m"
COLOR_GRAY="\033[0;38;5;240m"
BOLD="\033[1m"
RESET="\033[0m"

update_plugin() {
    dir="$(dirname "$1")"
    plugin="$(basename "$1")"
    cd "$1" || exit 1
    git_output="$(LANG=en_US.UTF-8 git pull --progress 2>&1)"
    if [ "$git_output" = "Already up to date." ]; then
        printf "$dir/${COLOR_BLUE}${BOLD}${plugin}${RESET} "
        printf "$(git rev-parse --short HEAD) "
        printf "${COLOR_GREEN}${git_output}${RESET}\n"
    else
        printf "$dir/${COLOR_BLUE}${BOLD}${plugin}${RESET} "
        git rev-parse --short HEAD
        printf "${git_output}\n"
    fi
}

update_plugins() {
    mkdir -p "$HOME/log"
    logfile="$HOME/log/update-vim-plugins.log"
    printf "\n###################\n" >> "$logfile"
    date "+%Y-%m-%d %H:%M:%S" >> "$logfile"
    for p in "$HOME"/.vim/pack/plugins/start/*; do
        # using echo "$(...)" to print all function output at once
        echo "$(update_plugin "$p")" &
    done | tee -a "$logfile"
    wait
    for p in "$HOME"/.vim/pack/plugins/opt/*; do
        echo "$(update_plugin "$p")" &
    done | tee -a "$logfile"
    wait
}

case $1 in
-u|--update)  update_plugins; exit;;
esac

clone_repo() {
    sleep 0.1
    cd "$1" && git clone $3 "$2" > /dev/null 2>&1
    printf '.'
}

install_plugins() {
    input_file="$1"
    section="$2"
    lines="$(sed -n "/^\[$section\]/,/^\[/p" "$input_file" | grep '^[^#[]' | sed 's/\s*#.*$//')"
    while read -r plugin
    do
        [ $plugin ] || continue
        printf "  $plugin "
        # if $plugin contains a comma, save part after first comma as $params
        [[ $plugin == *,* ]] && params="--"${plugin#*,} || params=
        plugin=${plugin%%,*}  # keep part before first comma
        folder=${plugin##*/}
        folder=${folder%.git}
        dest_path="$HOME/.vim/pack/plugins/$section/$folder"
        [ -d "$dest_path" ] && echo -e "${COLOR_GRAY}Folder $folder does already exist${RESET}" && continue
        ((installation_count++))
        echo -e "${COLOR_GREEN}Installing '$folder'...${RESET}"
        if [[ "$plugin" == http* ]]; then
            url="$plugin"
        else
            url=https://github.com/"$plugin".git
        fi
        clone_repo "$dir" "$url" "$params" &
    done <<< "$lines"
}

installation_count=0

for types in start opt; do
    dir="$HOME/.vim/pack/plugins/$types/"
    echo -e "\n${BOLD}$dir${RESET}"
    mkdir -p "$dir"
    cd "$dir" || exit 1

    install_plugins ~/.dotfiles/vim/.vim/plugins $types
    if [[ ${MACHINE} = work* ]]; then
        install_plugins ~/.dotfiles/vim/.vim/plugins-work $types
    else
        install_plugins ~/.dotfiles/vim/.vim/plugins-home $types
    fi
done

printf "\nDownloading $installation_count plugins.\n"
wait
printf "\nDone.\n"
