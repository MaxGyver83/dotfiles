#!/bin/sh
usage() {
  printf 'Usage:\nwiki [-w] "Search term"\n'
  exit 1
}

[ $# = 0 ] && usage
TIDDLER_PATH=~/repos/tiddlywiki/Notizen/tiddlers
cd $TIDDLER_PATH
rg --line-number --no-heading --color=always --smart-case --glob '*.{tid,md}' "${@}" \
    | fzf -d ':' -n 2.. --ansi --no-sort --exit-0 --preview-window 'down:40%:+{2}' \
      --preview 'bat -l=md --style=numbers --color=always --highlight-line {2} {1}' \
    | sed -E "s|^(.*?):([0-9]+):(.*$)|'${TIDDLER_PATH}/\1' \+\2|" \
    | xargs --no-run-if-empty --open-tty nvim
